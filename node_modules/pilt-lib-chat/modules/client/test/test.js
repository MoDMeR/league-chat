var Client = require("../"),
	fs = require("fs"),
	joe = require("joe"),
	should = require("should"),
	credentialsPath = __dirname + "/credentials.json",
	credentialsExist = fs.existsSync(credentialsPath);

if (!credentialsExist) {
	throw new Error("File \"" + credentialsPath + "\" is missing.");
}

var credentials = require(credentialsPath),
	userCredentials = credentials.accounts[0],
	client;

joe.describe("plc:xmpp", function (describe, it) {
	describe("constructor", function (describe, it) {
		it("should instantiate without error", function () {
			(function instantiateClient() {
				client = new Client(userCredentials);
			}).should.not.throw();
		});
		it("should connect within 5 seconds", function (done) {
			var success = false;
			client.on("online", function onOnline() {
				success = true;
			});
			setTimeout(function () {
				success.should.be.true;
				done();
			}, 5000);
		});
	});
	describe("#disconnect", function (describe, it) {
		it("should disconnect without error", function () {
			(function disconnectClient() {
				client.disconnect();
			}).should.not.throw();
		});
	});
	
	describe("servers", function (describe, it, doneGeneratingTests) {
		// Wait 1 Second to let the server handle its business before
		// reconnecting to it.
		setTimeout(function () {
			credentials.accounts.forEach(function (account) {
				it("should be able to connect to " + account.server, function (done) {
					var client = new Client(account),
						success = false,
						id;
					client.on("online", function () {
						success = true;
					
						clearTimeout(id);
						client.disconnect();
						success.should.be.true;
						done();
					});
					id = setTimeout(function () {
						client.disconnect();
						success.should.be.true;
						done();
					}, 5000);
				});
			});
			doneGeneratingTests();
		}, 1000);
	});
});
